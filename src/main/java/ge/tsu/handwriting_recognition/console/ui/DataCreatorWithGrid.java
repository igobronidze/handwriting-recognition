package ge.tsu.handwriting_recognition.console.ui;import ge.tsu.handwriting_recognition.console.resources.Messages;import ge.tsu.handwriting_recognition.console.utils.ShowAlert;import ge.tsu.handwriting_recognition.console.utils.StageUtils;import ge.tsu.handwriting_recognition.model.NormalizedData;import ge.tsu.handwriting_recognition.neuralnetwork.MyNeuralNetwork;import ge.tsu.handwriting_recognition.service.NormalizedDataService;import ge.tsu.handwriting_recognition.service.NormalizedDataServiceImpl;import ge.tsu.handwriting_recognition.service.SystemParameterService;import ge.tsu.handwriting_recognition.service.SystemParameterServiceImpl;import ge.tsu.handwriting_recognition.systemsetting.SystemParameter;import javafx.event.ActionEvent;import javafx.event.EventHandler;import javafx.geometry.Insets;import javafx.geometry.Pos;import javafx.scene.Scene;import javafx.scene.control.Button;import javafx.scene.control.ComboBox;import javafx.scene.control.Label;import javafx.scene.control.TextField;import javafx.scene.layout.BorderPane;import javafx.scene.layout.GridPane;import javafx.scene.layout.HBox;import javafx.stage.Stage;import java.io.File;import java.io.FileOutputStream;import java.io.IOException;import java.io.ObjectOutputStream;import java.util.ArrayList;import java.util.List;import java.util.Random;public class DataCreatorWithGrid extends Stage {    private SystemParameterService systemParameterService = new SystemParameterServiceImpl();    private int testDataCreatorGridDefaultWidth = Integer.parseInt(systemParameterService.getSystemParameterValue(            "testDataCreatorGridDefaultWidth", "11"));    private int testDataCreatorGridDefaultHeight = Integer.parseInt(systemParameterService.getSystemParameterValue(            "testDataCreatorGridDefaultHeight", "11"));    private int testDataCreatorGridMaxWidth = Integer.parseInt(systemParameterService.getSystemParameterValue(            "testDataCreatorGridMaxWidth", "100"));    private int testDataCreatorGridMaxHeight = Integer.parseInt(systemParameterService.getSystemParameterValue(            "testDataCreatorGridMaxHeight", "100"));    private BorderPane root;    private TextField widthField;    private TextField heightField;    private ComboBox<String> dataSetsCombo;    private TextField answerField;    private boolean[][] coloredMatrix = new boolean[testDataCreatorGridMaxWidth][testDataCreatorGridMaxHeight];    private NormalizedDataService normalizedDataService = new NormalizedDataServiceImpl();    public DataCreatorWithGrid() {        this.setTitle(Messages.get("dataCreatorWithGrid"));        root = new BorderPane();        initTopPane();        initBottomPane();        reloadCenterPane(testDataCreatorGridDefaultWidth, testDataCreatorGridDefaultHeight);        this.setScene(new Scene(root));        StageUtils.setMaxSize(this);    }    private void reloadCenterPane(int width, int height) {        GridPane centerPane = new GridPane();        centerPane.setAlignment(Pos.CENTER);        int btnWidth = Integer.parseInt(systemParameterService.getSystemParameterValue("testDataCreatorWindowWidth", "900")) / width;        int btnHeight = (Integer.parseInt(systemParameterService.getSystemParameterValue("testDataCreatorWindowHeight", "650"))  - 90) / height;        int min = Math.min(btnWidth, btnHeight);        for (int i = 0; i < height; i++) {            for (int j = 0; j < width; j++) {                Button btn = new Button();                btn.setPrefHeight(min);                btn.setPrefWidth(min);                final int ii = i;                final int jj = j;                btn.setOnAction(new EventHandler<ActionEvent>() {                    @Override                    public void handle(ActionEvent event) {                        String color = coloredMatrix[ii][jj] ? "#e6ffff" : "#001a1a";                        btn.setStyle( "-fx-color: " + color + ";");                        coloredMatrix[ii][jj] = !coloredMatrix[ii][jj];                    }                });                btn.setStyle( "-fx-color: #e6ffff;");                coloredMatrix[i][j] = false;                centerPane.add(btn, j, i);            }        }        root.setCenter(centerPane);    }    private void initBottomPane() {        HBox bottomPane = new HBox();        bottomPane.setAlignment(Pos.CENTER);        bottomPane.setPadding(new Insets(0, 0, 10, 0));        bottomPane.setSpacing(10);        Label answerLabel = new Label(Messages.get("answer") + ":");        answerLabel.setStyle("-fx-font-family: sylfaen");        answerField = new TextField();        answerField.setOnAction(new EventHandler<ActionEvent>() {            @Override            public void handle(ActionEvent event) {                saveAction();            }        });        Label dataSetLabel = new Label(Messages.get("directory") + ":");        dataSetLabel.setStyle("-fx-font-family: sylfaen");        dataSetsCombo = new ComboBox<>();        dataSetsCombo.setPrefWidth(130);        dataSetsCombo.getItems().addAll(getAllDirectory());        if (dataSetsCombo.getItems().size() != 0) {            dataSetsCombo.setValue(dataSetsCombo.getItems().get(0));        }        Button saveButton = new Button(Messages.get("save"));        saveButton.setStyle("-fx-font-family: sylfaen");        saveButton.setOnAction(new EventHandler<ActionEvent>() {            @Override            public void handle(ActionEvent event) {                saveAction();            }        });        Button guessButton = new Button(Messages.get("guess"));        guessButton.setStyle("-fx-font-family: sylfaen");        guessButton.setOnAction(new EventHandler<ActionEvent>() {            @Override            public void handle(ActionEvent event) {                char ans = MyNeuralNetwork.guessCharacter(new NormalizedData(getHeightFromField(), getWidthFromField(), coloredMatrix));                ShowAlert.showSimpleAlert("" + ans);            }        });        Button trainButton = new Button(Messages.get("train"));        trainButton.setStyle("-fx-font-family: sylfaen");        trainButton.setOnAction(new EventHandler<ActionEvent>() {            @Override            public void handle(ActionEvent event) {                List<NormalizedData> normalizedDataList = normalizedDataService.getInputDatas(dataSetsCombo.getValue());                MyNeuralNetwork.trainNeural(normalizedDataList);            }        });        bottomPane.getChildren().addAll(answerLabel, answerField);        bottomPane.getChildren().addAll(dataSetLabel, dataSetsCombo, saveButton, trainButton, guessButton);        root.setBottom(bottomPane);    }    private List<String> getAllDirectory() {        List<String> directories = new ArrayList<>();        File file = new File(systemParameterService.getSystemParameterValue("testDataPath", "D:\\sg\\handwriting_recognition\\testdata"));        for (File f : file.listFiles()) {            if (f.isDirectory()) {                directories.add(f.getName());            }        }        return directories;    }    private void saveAction() {        if (answerField.getText() == null || answerField.getText().length() != 1) {            ShowAlert.showWarning(Messages.get("irrelevantAnswer"));            return;        }        if (dataSetsCombo.getValue() == null) {            ShowAlert.showWarning(Messages.get("pleaseChooseDirectory"));            return;        }        try {            String path = systemParameterService.getSystemParameterValue("testDataPath", "D:\\sg\\handwriting_recognition\\testdata") + "\\" + dataSetsCombo.getValue();            Random r = new Random();            ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(path + "\\" + r.nextLong() + ".txt"));            NormalizedData data = new NormalizedData(getHeightFromField(), getWidthFromField(), coloredMatrix, answerField.getText().charAt(0));            out.writeObject(data);            out.close();            answerField.setText("");            reloadCenterPane(getWidthFromField(), getHeightFromField());        } catch (IOException ex) {            ShowAlert.showWarning(Messages.get("cantSaveData"), ex);        }    }    private void initTopPane() {        HBox topPane = new HBox();        topPane.setAlignment(Pos.CENTER);        topPane.setSpacing(10);        topPane.setPadding(new Insets(10, 0, 0, 0));        Label widthLabel = new Label(Messages.get("width") + ":");        widthLabel.setStyle("-fx-font-family: sylfaen");        widthField = new TextField();        widthField.setText(Integer.toString(testDataCreatorGridDefaultWidth));        widthField.setOnAction(new EventHandler<ActionEvent>() {            @Override            public void handle(ActionEvent event) {                reloadCenterPane(getWidthFromField(), getHeightFromField());            }        });        topPane.getChildren().addAll(widthLabel, widthField);        Label heightLabel = new Label(Messages.get("height") + ":");        heightLabel.setStyle("-fx-font-family: sylfaen");        heightField = new TextField();        heightField.setText(Integer.toString(testDataCreatorGridDefaultHeight));        topPane.getChildren().addAll(heightLabel, heightField);        Button chooseButton = new Button(Messages.get("create"));        chooseButton.setStyle("-fx-font-family: sylfaen");        chooseButton.setOnAction(new EventHandler<ActionEvent>() {            @Override            public void handle(ActionEvent event) {                reloadCenterPane(getWidthFromField(), getHeightFromField());            }        });        topPane.getChildren().add(chooseButton);        root.setTop(topPane);    }    private int getWidthFromField() {        try {            int width = Integer.parseInt(widthField.getText());            if (width <=0 || width > testDataCreatorGridMaxWidth) {                widthField.setText(testDataCreatorGridDefaultWidth + "");                return testDataCreatorGridDefaultWidth;            }            return width;        } catch (NumberFormatException ex) {            widthField.setText(testDataCreatorGridDefaultWidth + "");            return testDataCreatorGridDefaultWidth;        }    }    private int getHeightFromField() {        try {            int height = Integer.parseInt(heightField.getText());            if (height <=0 || height > testDataCreatorGridMaxWidth) {                heightField.setText(testDataCreatorGridDefaultWidth + "");                return testDataCreatorGridDefaultWidth;            }            return height;        } catch (NumberFormatException ex) {            heightField.setText(testDataCreatorGridDefaultHeight + "");            return testDataCreatorGridDefaultHeight;        }    }}